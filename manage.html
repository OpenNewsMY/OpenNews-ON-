export default {
  async fetch(request, env, ctx) {
    if (request.method === "OPTIONS") {
      return new Response(null, {
        status: 204,
        headers: {
          "Access-Control-Allow-Origin": "*",
          "Access-Control-Allow-Methods": "POST, OPTIONS",
          "Access-Control-Allow-Headers": "Content-Type"
        }
      });
    }

    if (request.method !== "POST") {
      return new Response("Method not allowed", { status: 405 });
    }

    function corsHeaders(body, status = 200) {
      return new Response(body, {
        status,
        headers: {
          "Access-Control-Allow-Origin": "*",
          "Access-Control-Allow-Methods": "POST, OPTIONS",
          "Access-Control-Allow-Headers": "Content-Type"
        }
      });
    }

    const body = await request.json();
    const { filename, content, updateJson, deleteId } = body;

    const owner = env.GITHUB_OWNER;
    const repo = env.GITHUB_REPO;
    const token = env.GITHUB_TOKEN;
    const branch = "main";
    const jsonPath = env.GITHUB_JSON_PATH;

    const apiHeaders = {
      Authorization: `Bearer ${token}`,
      "User-Agent": "OpenNewsPublisher"
    };

    async function uploadToGitHub(path, data, message, sha = null) {
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
      const payload = {
        message,
        content: btoa(unescape(encodeURIComponent(data))),
        branch
      };
      if (sha) payload.sha = sha;

      const res = await fetch(url, {
        method: "PUT",
        headers: { ...apiHeaders, "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(await res.text());
    }

    async function deleteFromGitHub(path) {
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
      const res = await fetch(url, { headers: apiHeaders });
      if (!res.ok) throw new Error("找不到要删除的文件：" + path);
      const { sha } = await res.json();

      const delRes = await fetch(url, {
        method: "DELETE",
        headers: { ...apiHeaders, "Content-Type": "application/json" },
        body: JSON.stringify({
          message: `删除 ${path}`,
          sha,
          branch
        })
      });
      if (!delRes.ok) throw new Error(await delRes.text());
    }

    if (deleteId) {
      const articlePath = `article-${deleteId}.html`;
      const jsonUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${jsonPath}`;

      try {
        await deleteFromGitHub(articlePath);
        const res = await fetch(jsonUrl, { headers: apiHeaders });
        const jsonFile = await res.json();
        const data = JSON.parse(atob(jsonFile.content));
        const updated = data.filter(item => item.id !== deleteId);

        await uploadToGitHub(
          jsonPath,
          JSON.stringify(updated, null, 2),
          `删除文章 ID ${deleteId}`,
          jsonFile.sha
        );

        return corsHeaders("✅ 删除成功", 200);
      } catch (err) {
        return corsHeaders("❌ 删除失败：" + err.message, 500);
      }
    }

    try {
      await uploadToGitHub(filename, content, `新增 ${filename}`);

      if (updateJson) {
        const jsonUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${jsonPath}`;
        const res = await fetch(jsonUrl, { headers: apiHeaders });
        const jsonFile = await res.json();
        const existing = JSON.parse(atob(jsonFile.content));
        existing.push(updateJson);

        await uploadToGitHub(
          jsonPath,
          JSON.stringify(existing, null, 2),
          `更新 ${jsonPath}：追加 ${updateJson.id}`,
          jsonFile.sha
        );
      }

      return corsHeaders("✅ 上传成功", 200);
    } catch (err) {
      return corsHeaders("❌ 错误：" + err.message, 500);
    }
  }
};
