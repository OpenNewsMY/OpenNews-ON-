<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OpenNews åå°ç®¡ç†</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #f9f9f9;
    }
    h1 {
      color: #222;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }
    input, textarea, select {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.5rem;
      box-sizing: border-box;
    }
    button {
      margin-top: 1rem;
      padding: 0.7rem 1.5rem;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    pre {
      background: #eee;
      padding: 1rem;
      white-space: pre-wrap;
      word-wrap: break-word;
      margin-top: 2rem;
    }
    .preview {
      background: #fff;
      border: 1px solid #ccc;
      padding: 1rem;
      margin-top: 1rem;
    }
    nav {
      margin-top: 2rem;
      margin-bottom: 2rem;
    }
    nav button {
      margin-right: 0.5rem;
    }
    .article-list {
      margin-top: 2rem;
    }
    .article-list table {
      width: 100%;
      border-collapse: collapse;
    }
    .article-list th, .article-list td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    .article-list th {
      background: #eee;
    }
    .article-list td button {
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>

  <script>
    const password = "opennews2025";
    if (sessionStorage.getItem("access") !== "granted") {
      const input = prompt("è¯·è¾“å…¥åå°å¯†ç ");
      if (input !== password) {
        alert("å¯†ç é”™è¯¯ï¼Œæ— æ³•è¿›å…¥åå°");
        window.location.href = "/";
      } else {
        sessionStorage.setItem("access", "granted");
      }
    }
  </script>

  <h1>ğŸ”’ OpenNews åå°ç®¡ç†å·¥å…·</h1>

  <nav>
    <button onclick="showTab('editor')">ğŸ“ å‘å¸ƒæ–‡ç« </button>
    <button onclick="showTab('manager')">ğŸ“ æ–‡ç« ç®¡ç†</button>
  </nav>

  <div id="editor">
    <label for="title">æ ‡é¢˜</label>
    <input type="text" id="title">

    <label for="date">å‘å¸ƒæ—¥æœŸ</label>
    <input type="text" id="date" placeholder="å¦‚ï¼š2025å¹´4æœˆ3æ—¥">

    <label for="category">åˆ†ç±»</label>
    <select id="category">
      <option>æ”¿æ²»</option>
      <option>æœ¬åœ°æ–°é—»</option>
      <option>å›½é™…</option>
      <option>å…«å¦</option>
      <option>å†·çŸ¥è¯†</option>
      <option>åºŸé—»</option>
    </select>

    <label for="imageUpload">ä¸Šä¼ å›¾ç‰‡</label>
    <input type="file" id="imageUpload" accept="image/*">
    <p style="font-size: 0.9rem; color: #777;">å°†å›¾ç‰‡è‡ªåŠ¨ä¸Šä¼ è‡³ GitHub images æ–‡ä»¶å¤¹</p>
    <div id="uploadStatus"></div>

    <label for="summary">æ‘˜è¦</label>
    <textarea id="summary" rows="3"></textarea>

    <label for="content">æ–‡ç« å†…å®¹</label>
    <textarea id="content" rows="6"></textarea>

    <button onclick="previewArticle()">é¢„è§ˆæ–‡ç« </button>
    <button onclick="publishArticle()">ğŸš€ å‘å¸ƒæ–‡ç« </button>

    <div class="preview" id="preview"></div>
    <pre id="output"></pre>
  </div>

  <div id="manager" style="display:none;">
    <h2>ğŸ“ æ‰€æœ‰æ–‡ç« </h2>
    <div class="article-list" id="articleTable"></div>
  </div>

  <script>
    let articleId = 100;
    let uploadedImagePath = "";
    let allArticles = [];

    async function showTab(tab) {
      document.getElementById('editor').style.display = tab === 'editor' ? 'block' : 'none';
      document.getElementById('manager').style.display = tab === 'manager' ? 'block' : 'none';
      if (tab === 'manager') loadArticleList();
    }

    async function loadArticleList() {
      const res = await fetch('../articles.json');
      const data = await res.json();
      allArticles = data;
      let html = `<table><tr><th>ID</th><th>æ ‡é¢˜</th><th>åˆ†ç±»</th><th>æ—¶é—´</th><th>æ“ä½œ</th></tr>`;
      for (const item of data) {
        html += `<tr>
          <td>${item.id}</td>
          <td>${item.title}</td>
          <td>${item.category}</td>
          <td>${item.date}</td>
          <td>
            <button onclick='editArticle(${item.id})'>âœï¸ ç¼–è¾‘</button>
            <button onclick='deleteArticle(${item.id})'>ğŸ—‘ åˆ é™¤</button>
          </td>
        </tr>`;
      }
      html += `</table>`;
      document.getElementById("articleTable").innerHTML = html;
    }

    function editArticle(id) {
      const item = allArticles.find(x => x.id === id);
      articleId = item.id;
      document.getElementById("title").value = item.title;
      document.getElementById("date").value = item.date;
      document.getElementById("category").value = item.category;
      document.getElementById("summary").value = item.summary;
      document.getElementById("content").value = item.content;
      uploadedImagePath = item.image;
      showTab('editor');
    }

    async function deleteArticle(id) {
      const confirmDelete = confirm("ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿ");
      if (!confirmDelete) return;
      const res = await fetch("https://opennews-delete.opennews-my.workers.dev/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      });
      if (res.ok) {
        alert("âœ… å·²åˆ é™¤æ–‡ç«  ID " + id);
        loadArticleList();
      } else {
        alert("âŒ åˆ é™¤å¤±è´¥");
      }
    }

    async function fetchNextId() {
      try {
        const res = await fetch("../articles.json");
        const data = await res.json();
        const maxId = data.reduce((max, article) => Math.max(max, article.id || 0), 0);
        articleId = maxId + 1;
      } catch {}
    }
    fetchNextId();

    document.getElementById('imageUpload').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(event) {
        const base64 = event.target.result.split(',')[1];
        const res = await fetch("https://opennews-uploader.opennews-my.workers.dev/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ filename: file.name, content: base64 })
        });
        if (res.ok) {
          const data = await res.json();
          uploadedImagePath = data.url;
          document.getElementById("uploadStatus").innerHTML = `âœ… ä¸Šä¼ æˆåŠŸï¼š<code>${uploadedImagePath}</code>`;
        }
      };
      reader.readAsDataURL(file);
    });

    function previewArticle() {
      const article = collectData();
      const img = article.image ? `<img src='${article.image}' style='max-width:100%;'>` : "";
      document.getElementById("preview").innerHTML = `
        <h3>${article.title}</h3>
        <p><strong>${article.date}</strong> | åˆ†ç±»ï¼š${article.category}</p>
        ${img}<p><strong>æ‘˜è¦ï¼š</strong>${article.summary}</p>
        <p>${article.content}</p>`;
    }

    function collectData() {
      return {
        id: articleId,
        title: document.getElementById("title").value,
        date: document.getElementById("date").value,
        category: document.getElementById("category").value,
        image: uploadedImagePath,
        summary: document.getElementById("summary").value,
        content: document.getElementById("content").value
      };
    }

    async function publishArticle() {
      const article = collectData();
      const filename = `article-${article.id}.html`;
      const html = `<!DOCTYPE html><html lang='zh-Hans'><head><meta charset='UTF-8'><meta name='viewport' content='width=device-width, initial-scale=1.0'><title>${article.title}</title><meta property='og:title' content='${article.title}'><meta property='og:description' content='${article.summary}'>${article.image ? `<meta property='og:image' content='${article.image}'>` : ""}<meta property='og:type' content='article'><style>body{font-family:sans-serif;padding:2rem;max-width:800px;margin:auto;background:#fef9f1;}img{max-width:100%;border-radius:8px;margin:1rem 0;}</style></head><body><h1>${article.title}</h1><p>${article.date} ï½œ åˆ†ç±»ï¼š${article.category}</p>${article.image ? `<img src='${article.image}' alt=''>` : ""}<p><strong>${article.summary}</strong></p><div>${article.content}</div></body></html>`;

      const res1 = await fetch("https://opennews-publish.opennews-my.workers.dev/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename, content: html })
      });
      const res2 = await fetch("https://opennews-articles.opennews-my.workers.dev/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(article)
      });

      if (res1.ok && res2.ok) {
        alert("âœ… å·²å‘å¸ƒæ–‡ç« ï¼");
        showTab('manager');
      } else {
        alert("âŒ å‘å¸ƒå¤±è´¥");
      }
    }
  </script>
</body>
</html>

