<script>
    let articleId = 101;
    let uploadedImagePath = "";

    async function fetchLatestArticleId() {
      try {
        const res = await fetch("https://opennewsmy.github.io/OpenNews-ON-/articles.json");
        const articles = await res.json();
        const maxId = articles.reduce((max, a) => a.id > max ? a.id : max, 0);
        articleId = maxId + 1;
        console.log("自动设定 articleId 为：" + articleId);
      } catch (e) {
        console.warn("⚠️ 无法读取 articles.json，使用默认 ID 101");
        articleId = 101;
      }
    }

    document.addEventListener("DOMContentLoaded", fetchLatestArticleId);

    document.getElementById('imageUpload').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(event) {
        const base64 = event.target.result.split(',')[1];
        const res = await fetch("https://opennews-uploader.opennews-my.workers.dev/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ filename: file.name, content: base64 })
        });
        if (res.ok) {
          const data = await res.json();
          uploadedImagePath = data.url;
          document.getElementById("uploadStatus").innerHTML = `✅ 上传成功：<a href='${uploadedImagePath}' target='_blank'>${uploadedImagePath}</a>`;
        } else {
          const err = await res.text();
          document.getElementById("uploadStatus").innerHTML = `❌ 上传失败：${err}`;
        }
      };
      reader.readAsDataURL(file);
    });

    function collectArticleData() {
      return {
        id: articleId,
        title: document.getElementById('title').value,
        date: document.getElementById('date').value,
        category: document.getElementById('category').value,
        image: uploadedImagePath,
        summary: document.getElementById('summary').value,
        content: document.getElementById('content').value
      };
    }

    async function publishArticle() {
      const article = collectArticleData();
      const filename = `article-${article.id}.html`;
      const ogImage = article.image ? `<meta property='og:image' content='${article.image}'>` : "";

      const html = `<!DOCTYPE html>
<html lang='zh-Hans'>
<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>${article.title}</title>
  <meta property='og:title' content='${article.title}'>
  <meta property='og:description' content='${article.summary}'>
  ${ogImage}
  <meta property='og:url' content='https://opennewsmy.github.io/OpenNews-ON-/${filename}'>
  <meta property='og:type' content='article'>
  <meta name='twitter:card' content='summary_large_image'>
  <style>
    body { font-family: sans-serif; background: #fef9f1; padding: 2rem; max-width: 800px; margin: auto; line-height: 1.7; }
    img { max-width: 100%; border-radius: 8px; margin: 1rem 0; }
    .meta { color: #555; font-size: 0.9rem; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <h1>${article.title}</h1>
  <div class='meta'>${article.date} ｜ 分类：${article.category}</div>
  ${article.image ? `<img src='${article.image}' alt=''>` : ""}
  <p><strong>${article.summary}</strong></p>
  <div>${article.content}</div>
</body>
</html>`;

      const res = await fetch("https://opennews-publish.opennews-my.workers.dev/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename, content: html, updateJson: article })
      });

      if (res.ok) {
        const url = `https://opennewsmy.github.io/OpenNews-ON-/${filename}`;
        alert("✅ 上传成功！你可以分享链接：\n" + url);
      } else {
        const err = await res.text();
        alert("❌ 上传失败：" + err);
      }
    }
</script>

