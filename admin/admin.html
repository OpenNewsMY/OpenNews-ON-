<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OpenNews åå°ç®¡ç†</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #f9f9f9;
    }
    h1 {
      color: #222;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }
    input, textarea, select {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.5rem;
      box-sizing: border-box;
    }
    button {
      margin-top: 1rem;
      padding: 0.7rem 1.5rem;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    pre {
      background: #eee;
      padding: 1rem;
      white-space: pre-wrap;
      word-wrap: break-word;
      margin-top: 2rem;
    }
    .preview {
      background: #fff;
      border: 1px solid #ccc;
      padding: 1rem;
      margin-top: 1rem;
    }
  </style>
</head>
<body>

  <script>
    const password = "opennews2025";
    if (sessionStorage.getItem("access") !== "granted") {
      const input = prompt("è¯·è¾“å…¥åå°å¯†ç ");
      if (input !== password) {
        alert("å¯†ç é”™è¯¯ï¼Œæ— æ³•è¿›å…¥åå°");
        window.location.href = "/";
      } else {
        sessionStorage.setItem("access", "granted");
      }
    }
  </script>

  <h1>ğŸ”’ OpenNews åå°ç®¡ç†å·¥å…·</h1>

  <label for="title">æ ‡é¢˜</label>
  <input type="text" id="title">

  <label for="date">å‘å¸ƒæ—¥æœŸ</label>
  <input type="text" id="date" placeholder="å¦‚ï¼š2025å¹´4æœˆ3æ—¥">

  <label for="category">åˆ†ç±»</label>
  <select id="category">
    <option>æ”¿æ²»</option>
    <option>æœ¬åœ°æ–°é—»</option>
    <option>å›½é™…</option>
    <option>å…«å¦</option>
    <option>å†·çŸ¥è¯†</option>
    <option>åºŸé—»</option>
  </select>

  <label for="imageUpload">ä¸Šä¼ å›¾ç‰‡</label>
  <input type="file" id="imageUpload" accept="image/*">
  <p style="font-size: 0.9rem; color: #777;">å›¾ç‰‡ä¼šè‡ªåŠ¨ä¸Šä¼ åˆ° GitHub images æ–‡ä»¶å¤¹</p>
  <div id="uploadStatus"></div>

  <label for="summary">æ‘˜è¦</label>
  <textarea id="summary" rows="3"></textarea>

  <label for="content">æ–‡ç« å†…å®¹</label>
  <textarea id="content" rows="6"></textarea>

  <button onclick="previewArticle()">é¢„è§ˆæ–‡ç« </button>
  <button onclick="generateJSON()">ç”Ÿæˆ JSON</button>
  <button onclick="generateHTML()">ç”Ÿæˆé™æ€ HTML</button>
  <button onclick="publishArticle()">ğŸš€ å‘å¸ƒæ–‡ç« ï¼ˆè‡ªåŠ¨ä¸Šä¼ åˆ° GitHubï¼‰</button>

  <div class="preview" id="preview"></div>
  <pre id="output"></pre>

  <hr>
  <h2>ğŸ“‚ ä¸Šä¼  JSON æ‰¹é‡å¯¼å…¥</h2>
  <input type="file" id="jsonFile" accept=".json">
  <pre id="uploaded"></pre>

  <script>
    let articleId = 101;
    let uploadedImagePath = "";

    document.getElementById('imageUpload').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(event) {
        const base64 = event.target.result.split(',')[1];
        const res = await fetch("https://opennews-uploader.opennews-my.workers.dev/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ filename: file.name, content: base64 })
        });

        if (res.ok) {
          const data = await res.json();
          uploadedImagePath = data.url;
          document.getElementById("uploadStatus").innerHTML = âœ… ä¸Šä¼ æˆåŠŸï¼š<a href='${uploadedImagePath}' target='_blank'>${uploadedImagePath}</a>;
        } else {
          const err = await res.text();
          document.getElementById("uploadStatus").innerHTML = âŒ ä¸Šä¼ å¤±è´¥ï¼š${err};
        }
      };
      reader.readAsDataURL(file);
    });

    function collectArticleData() {
      return {
        id: articleId,
        title: document.getElementById('title').value,
        date: document.getElementById('date').value,
        category: document.getElementById('category').value,
        image: uploadedImagePath,
        summary: document.getElementById('summary').value,
        content: document.getElementById('content').value
      };
    }

    function generateJSON() {
      const json = collectArticleData();
      document.getElementById('output').textContent = JSON.stringify(json, null, 2);
    }

    function previewArticle() {
      const { title, date, category, summary, content } = collectArticleData();
      const img = uploadedImagePath ? <img src="${uploadedImagePath}" style="max-width:100%;"><br><br> : "";
      const html = 
        <h3>${title}</h3>
        <p><strong>${date}</strong> | åˆ†ç±»ï¼š${category}</p>
        ${img}
        <p><strong>æ‘˜è¦ï¼š</strong>${summary}</p>
        <p>${content}</p>
      ;
      document.getElementById('preview').innerHTML = html;
    }

    async function publishArticle() {
      const article = collectArticleData();
      const filename = article-${article.id}.html;
      const ogImage = article.image ? <meta property='og:image' content='${article.image}'> : "";
      const html = <!DOCTYPE html>
<html lang='zh-Hans'>
<head>
  <meta charset='UTF-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>${article.title}</title>
  <meta property='og:title' content='${article.title}'>
  <meta property='og:description' content='${article.summary}'>
  ${ogImage}
  <meta property='og:url' content='https://opennewsmy.github.io/OpenNews-ON-/${filename}'>
  <meta property='og:type' content='article'>
  <meta name='twitter:card' content='summary_large_image'>
  <style>
    body { font-family: sans-serif; background: #fef9f1; padding: 2rem; max-width: 800px; margin: auto; line-height: 1.7; }
    img { max-width: 100%; border-radius: 8px; margin: 1rem 0; }
    .meta { color: #555; font-size: 0.9rem; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <h1>${article.title}</h1>
  <div class='meta'>${article.date} ï½œ åˆ†ç±»ï¼š${article.category}</div>
  ${article.image ? <img src='${article.image}' alt=''> : ""}
  <p><strong>${article.summary}</strong></p>
  <div>${article.content}</div>
</body>
</html>;

      const res = await fetch("https://opennews-publish.opennews-my.workers.dev/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename, content: html })
      });

      if (res.ok) {
        const url = https://opennewsmy.github.io/OpenNews-ON-/${filename};
        alert("âœ… ä¸Šä¼ æˆåŠŸï¼ä½ å¯ä»¥åˆ†äº«é“¾æ¥ï¼š\n" + url);
      } else {
        const err = await res.text();
        alert("âŒ ä¸Šä¼ å¤±è´¥ï¼š" + err);
      }
    }

    document.getElementById('jsonFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          document.getElementById('uploaded').textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          alert('ä¸Šä¼ çš„æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„ JSON');
        }
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
